# 标志寄存器



-   8086 CPU 有 14 个寄存器
    -   通用寄存器
        -   AX、BX、CX、DX
    -   变址寄存器
        -   SI、DI
    -   指针寄存器
        -   SP、BP
    -   指令指针寄存器
        -   IP
    -   段寄存器
        -   CS、SS、DS、ES
    -   标志（flag）寄存器（别称：程序状态字）
        -   PSW/FLAGS



## 认识标志寄存器的特殊之处



-   标志寄存器的结构

    -   flag 寄存器是按位起作用的，也就是说，它的每一个位都有专门的含义，记录特定的信息。
    -   8086 CPU 中没有使用 flag 的1、3、5、12、13、14、15位，这些位不具有任何含义。

-   标志寄存器的作用

    -   用来存储相关指令的某些执行结果
    -   用来为 CPU 执行相关指令提供行为依据
    -   用来控制 CPU 的相关工作方式

-   观察寄存器的值

    -   ```bash
        AX=0000        BX=0000        CX=0000        DX=0000        SP=FFFF        BP=0000        SI=0000        DI=0000
        DS=****        ES=****        SS=****        CS=****        IP=0100        NU  UP  EI  PL  NZ  NA  PO  NC
        #                                                                           ↑   ↑       ↑   ↑       ↑   ↑
        #                                                                          OF  DF      SF   ZF     PF  CF
        ```
    
-   直接访问标志寄存器的方法

    -   pushf
        -   将标志寄存器的值压栈
    -   popf
        -   从栈中弹出数据，送入标志寄存器中





| 位序号 | 含义 |
| :----: | :--: |
|   15   |      |
|   14   |      |
|   13   |      |
|   12   |      |
|   11   |  OF  |
|   10   |  DF  |
|   9    |  IF  |
|   8    |  TF  |
|   7    |  SF  |
|   6    |  ZF  |
|   5    |      |
|   4    |  AF  |
|   3    |      |
|   2    |  PF  |
|   1    |      |
|   0    |  CF  |



|           | 标志 | 值为：0 | 值为：1 | 意义 |                   |
| :-------: | :--: | :-----: | :-----: | :--: | :---------------: |
| Overflow  |  OF  |   OV    |   NV    | 溢出 |                   |
| Direction |  DF  |   ON    |   UP    | 方向 |                   |
|   Sign    |  SF  |   NG    |   PL    | 符号 | Positive/negative |
|   Zero    |  ZF  |   ZR    |   NZ    | 零值 |                   |
|  Parity   |  PF  |   PE    |   PO    | 奇偶 |     odd/even      |
|   Carry   |  CF  |   CY    |   NC    | 进位 |                   |





## ZF----零标志（Zero Flag）



-   ZF 标记相关指令的计算结果是否为0

    -   ZF=1，表示 "结果是0" ，1 表示 “逻辑真”
    -   ZF=0，表示 "结果不是0" ，0 表示 “逻辑假”

-   示例

    -   | 指令                 | 执行结果                |
        | -------------------- | ----------------------- |
        | mov ax,1<br>and ax,0 | ZF=1<br>表示 “结果是0”  |
        | mov ax,1<br>or ax,0  | ZF=0<br/>表示 “结果非0” |

        

-   在 8086 CPU 的指令集中，有的指令执行是影响标志寄存器的，比如：`add sub mul div inc or and` 等，它们大都都是运算指令，进行逻辑或算术运算
-   有的指令的执行对标志寄存器没有影响，比如：`mov push pop` 等，它们大都是传送指令
-   使用一条指令的时候，要注意这条指令的全部功能，其中包括执行结果对标志寄存器的哪些标志位造成了影响



## PF----奇偶标志（Parity Flag）



-   PF 记录指令执行后，结果的所有二进制位中 1 的个数

    -   1 的个数为偶数，PF=1
    -   1 的个数为奇数，PF=0

-   示例

    -   | 指令                  | 执行结果                                                     |
        | --------------------- | ------------------------------------------------------------ |
        | mov al,1<br>add al,10 | 结果为：`0000 1011B = 0000 0001B + 0000 1010B` 其中有 3（奇数）个 1，则 PF = 0 |
        | mov al,1<br>or al,2   | 结果为：`0000 0011B = 0000 0001B or 0000 0010B` 其中有 2（偶数）个 1，则 PF = 1 |

        



## SF----符号标志（Sign Flag）



-   SF 记录指令执行后，将结果视为有符号数

    -   结果为负，SF = 1
    -   结果为非负，SF = 0

-   示例

    -   | 指令                             | 执行结果                                  |
        | -------------------------------- | ----------------------------------------- |
        | `mov al,10000001B`<br>`add al,1` | 结果 al 为 `10000010B`，为负数，则 SF = 1 |
        | sub ax,ax                        | 结果 al 为 0，为非负数，则 SF = 0         |

        >   `1000 0010B` 作为有符号数对应 `-111 1110B`，即 `-126D`
        >
        >   `1000 0010B` 作为无符号数对应 `+1000 0010B`，即 `+130D`

        >   [!NOTE]
        >
        >   `1000 0010B` 究竟算是正数还是负数？？？
        >
        >   >    SF 标志是 CPU 对有符号数运算结果的一种记录。将数据当作有符号数来运算的时候，通过 SF 可知结果的正负；将数据当作无符号数来运算，SF 的值则没有意义，虽然相关的指令影响了它的值

        

>   [!TIP]
>
>   -   基础：有符号数与补码
>       -   计算机中有符号数一律使用补码来表示和存储
>       -   正整数的补码是其二进制表示，与原码相同
>           -   例：+9 的补码是 `0000 1001`
>       -   负整数的补码，将其对应的正数二进制的所有位取反（包括符号位，0 变 1，1 变 0 ）后加1
>           -   例：-5 的补码
>               -   -5 对应正数 5（0000 0101）所有位取反（1111 1010）加 1 （1111 1011）
>               -   所以 -5 的补码是 1111 1011



## CF----进位标志（Carry Flag）



-   在进行无符号数运算的时候，CF 记录了运算结果的最高有效位向更高位的进位值，或从更高位的借位值

-   CF 记录指令执行后

    -   有进位或借位，CF = 1
    -   无进位或借位，CF = 0

-   示例

    -   | 指令                    | 执行结果                                              |
        | ----------------------- | ----------------------------------------------------- |
        | mov al,98H<br>add al,al | (al)=30H，CF = 1，CF 记录了最高有效位向更高位的进位值 |
        | add al,al               | (al)=60H，CF = 0，CF 记录了最高有效位向更高位的进位值 |
        | sub al,98H              | (al)=C8H，CF = 1，CF 记录了最高有效位向更高位的借位值 |

        



-   对于位数为 N 的无符号数来说，其对应的二进制信息的最高位即第 N - 1 位，是最高有效位

-   假象存在的第 N 位，就是相对最高有效位的更高位

    -   ```bash
        #  8               7    6    5    4    3    2    1    0          } 8 位数据
        # [ ]             [ ]  [ ]  [ ]  [ ]  [ ]  [ ]  [ ]  [ ]         }
        #  ↑               ↑
        # 假想的更高位      最高有效位
        
        ####   对 16 位运算也适用
        ```





## OF----溢出标志（Overflow Flag）



-   在进行有符号数运算的时候，如结果超过了机器所能表示的范围称为**溢出**

-   OF 记录有符号数操作指令执行后

    -   有溢出，OF = 1
    -   无溢出，OF = 0

-   示例

    -   | 指令                      | 执行结果                                                |
        | ------------------------- | ------------------------------------------------------- |
        | mov al,98<br>add al,99    | (al)=197，超过了 8 位有符号数的范围（-128~127），OF = 1 |
        | mov al,0F0H<br>add al,88H | (al)=(-16)+(-120)=-136，有溢出，OF = 0                  |





-   机器所能表达的范围
    -   以 8 位运算为例，结果用 8 位寄存器或内存单元来存放，机器所能表示的范围就是 -128~127
    -   同理，对于 16 位有符号数，机器所能表示的范围是 -32768~32767
-   注意，此处的溢出**只是对有符号数运算**而言



>   [!NOTE]
>
>   -   CF 和 OF 的区别
>
>       -   CF 是对无符号数运算有意义的进/借位标志位
>       -   OF 是对有符号数运算有意义的溢出标志位
>
>   -   应用
>
>       -   | 指令                      | 执行结果                                               |
>           | ------------------------- | ------------------------------------------------------ |
>           | mov al,0F0H<br>add al,88H | CF=1，OF=1，当无符号数运算有进位，当有符号数运算有溢出 |



## 综合：一条指令会带来多个标志寄存器的变化



| 指令        |  CF  |  OF  |  SF  |  ZF  |  PF  |
| ----------- | :--: | :--: | :--: | :--: | :--: |
| sub al,al   |      |      |      |      |      |
| mov al,10h  |      |      |      |      |      |
| add al,90h  |      |      |      |      |      |
| mov al,80h  |      |      |      |      |      |
| add al,80h  |      |      |      |      |      |
| mov al,0FCh |      |      |      |      |      |
| add al,05h  |      |      |      |      |      |
| mov al,7Dh  |      |      |      |      |      |
| add al,0Bh  |      |      |      |      |      |

